version: "3.7"

# OnWapp Production Stack for Docker Swarm
# Replace 'yourdomain.com' with your actual domain

services:

  onwapp_postgres:
    image: postgres:16-alpine
    volumes:
      - onwapp_postgres_data:/var/lib/postgresql/data
    networks:
      - onwapp_network
    environment:
      - POSTGRES_DB=onwapp
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - TZ=America/Sao_Paulo
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  onwapp_nats:
    image: nats:latest
    command:
      - "--http_port=8222"
      - "--js"
      - "--store_dir=/data"
    volumes:
      - onwapp_nats_data:/data
    networks:
      - onwapp_network
    environment:
      - TZ=America/Sao_Paulo
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  onwapp_minio:
    image: quay.io/minio/minio:RELEASE.2024-01-13T07-53-03Z-cpuv1
    command: server /data --console-address ":9001"
    volumes:
      - onwapp_minio_data:/data
    networks:
      - onwapp_network
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_BROWSER_REDIRECT_URL=https://minio.yourdomain.com
      - MINIO_SERVER_URL=https://s3.yourdomain.com
      - TZ=America/Sao_Paulo
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        # MinIO S3 API
        - traefik.http.routers.onwapp_minio_public.rule=Host(`s3.yourdomain.com`)
        - traefik.http.routers.onwapp_minio_public.entrypoints=websecure
        - traefik.http.routers.onwapp_minio_public.tls.certresolver=letsencryptresolver
        - traefik.http.services.onwapp_minio_public.loadbalancer.server.port=9000
        - traefik.http.services.onwapp_minio_public.loadbalancer.passHostHeader=true
        - traefik.http.routers.onwapp_minio_public.service=onwapp_minio_public
        # MinIO Console
        - traefik.http.routers.onwapp_minio_console.rule=Host(`minio.yourdomain.com`)
        - traefik.http.routers.onwapp_minio_console.entrypoints=websecure
        - traefik.http.routers.onwapp_minio_console.tls.certresolver=letsencryptresolver
        - traefik.http.services.onwapp_minio_console.loadbalancer.server.port=9001
        - traefik.http.services.onwapp_minio_console.loadbalancer.passHostHeader=true
        - traefik.http.routers.onwapp_minio_console.service=onwapp_minio_console

  onwapp_api:
    image: onwapp/onwapp:latest
    volumes:
      - onwapp_data:/app/data
    networks:
      - onwapp_network
    environment:
      # Database
      - DATABASE_URL=postgres://postgres:postgres@onwapp_postgres:5432/onwapp?sslmode=disable
      # Server
      - PORT=3000
      - GLOBAL_API_KEY=your-api-key-here
      - SERVER_URL=https://api.yourdomain.com
      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      # MinIO
      - MINIO_ENDPOINT=onwapp_minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=onwapp-media
      - MINIO_USE_SSL=false
      - MINIO_PUBLIC_URL=https://s3.yourdomain.com
      # NATS
      - NATS_ENABLED=true
      - NATS_URL=nats://onwapp_nats:4222
      - NATS_STREAM_PREFIX=ONWAPP
      - TZ=America/Sao_Paulo
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M
      labels:
        - traefik.enable=true
        - traefik.docker.network=onwapp_network
        - traefik.http.routers.onwapp_api.rule=Host(`api.yourdomain.com`)
        - traefik.http.routers.onwapp_api.entrypoints=websecure
        - traefik.http.routers.onwapp_api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.onwapp_api.priority=1
        - traefik.http.routers.onwapp_api.service=onwapp_api
        - traefik.http.services.onwapp_api.loadbalancer.server.port=3000
        - traefik.http.services.onwapp_api.loadbalancer.passhostheader=true
        - traefik.http.middlewares.onwapp_sslheader.headers.customrequestheaders.X-Forwarded-Proto=https
        - traefik.http.routers.onwapp_api.middlewares=onwapp_sslheader@docker

volumes:
  onwapp_postgres_data:
    driver: local
  onwapp_nats_data:
    driver: local
  onwapp_minio_data:
    driver: local
  onwapp_data:
    driver: local

networks:
  onwapp_network:
    driver: overlay
    attachable: true
