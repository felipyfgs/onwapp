version: "3.7"

services:

  zpwoot_postgres:
    image: postgres:16-alpine
    volumes:
      - zpwoot_postgres_data:/var/lib/postgresql/data
    networks:
      - infraNet
    environment:
      - POSTGRES_DB=zpwoot
      - POSTGRES_USER=zpwoot
      - POSTGRES_PASSWORD=zpwoot123
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  zpwoot_nats:
    image: nats:latest
    command:
      - "--http_port=8222"
      - "--js"
      - "--store_dir=/data"
    volumes:
      - zpwoot_nats_data:/data
    networks:
      - infraNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  zpwoot_minio:
    image: quay.io/minio/minio:RELEASE.2024-01-13T07-53-03Z-cpuv1
    command: server /data --console-address ":9001"
    hostname: minio
    volumes:
      - zpwoot_minio_data:/data
    networks:
      infraNet:
        aliases:
          - minio
    environment:
      - MINIO_ROOT_USER=zpwoot
      - MINIO_ROOT_PASSWORD=zpwoot123
      - MINIO_BROWSER_REDIRECT_URL=https://minio.yourdomain.com
      - MINIO_SERVER_URL=https://s3.yourdomain.com
    deploy:

  zpwoot_createbuckets:
    image: minio/mc:latest
    networks:
      - infraNet
    entrypoint: >
      /bin/sh -c "
      sleep 10;
      /usr/bin/mc alias set myminio http://minio:9000 zpwoot zpwoot123;
      /usr/bin/mc mb myminio/zpwoot-media --ignore-existing;
      /usr/bin/mc anonymous set download myminio/zpwoot-media;
      exit 0;
      "
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == manager

  zpwoot_minio_deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
      labels:
        - traefik.enable=true
        - traefik.docker.network=infraNet
        - traefik.http.routers.zpwoot_minio_public.rule=Host(`s3.yourdomain.com`)
        - traefik.http.routers.zpwoot_minio_public.entrypoints=websecure
        - traefik.http.routers.zpwoot_minio_public.tls.certresolver=letsencryptresolver
        - traefik.http.services.zpwoot_minio_public.loadbalancer.server.port=9000
        - traefik.http.services.zpwoot_minio_public.loadbalancer.passHostHeader=true
        - traefik.http.routers.zpwoot_minio_public.service=zpwoot_minio_public
        - traefik.http.routers.zpwoot_minio_console.rule=Host(`minio.yourdomain.com`)
        - traefik.http.routers.zpwoot_minio_console.entrypoints=websecure
        - traefik.http.routers.zpwoot_minio_console.tls.certresolver=letsencryptresolver
        - traefik.http.services.zpwoot_minio_console.loadbalancer.server.port=9001
        - traefik.http.services.zpwoot_minio_console.loadbalancer.passHostHeader=true
        - traefik.http.routers.zpwoot_minio_console.service=zpwoot_minio_console

  zpwoot_api:
    image: onwapp/zpwoot:latest
    volumes:
      - zpwoot_data:/app/data
    networks:
      - infraNet
    environment:
      # Database
      - DATABASE_URL=postgres://zpwoot:zpwoot123@zpwoot_postgres:5432/zpwoot?sslmode=disable
      # Server
      - PORT=3000
      - API_KEY=your-api-key-here
      - SERVER_URL=https://wpapi.yourdomain.com
      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      # MinIO
      - MINIO_ENDPOINT=s3.yourdomain.com
      - MINIO_ACCESS_KEY=zpwoot
      - MINIO_SECRET_KEY=zpwoot123
      - MINIO_BUCKET=zpwoot-media
      - MINIO_USE_SSL=true
      - MINIO_PUBLIC_URL=https://s3.yourdomain.com
      # NATS
      - NATS_ENABLED=true
      - NATS_URL=nats://zpwoot_nats:4222
      - NATS_STREAM_PREFIX=ZPWOOT
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M
      labels:
        - traefik.enable=true
        - traefik.docker.network=infraNet
        - traefik.http.routers.zpwoot_api.rule=Host(`wpapi.yourdomain.com`)
        - traefik.http.routers.zpwoot_api.entrypoints=websecure
        - traefik.http.routers.zpwoot_api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.zpwoot_api.priority=1
        - traefik.http.routers.zpwoot_api.service=zpwoot_api
        - traefik.http.services.zpwoot_api.loadbalancer.server.port=3000
        - traefik.http.services.zpwoot_api.loadbalancer.passhostheader=true
        - traefik.http.middlewares.zpwoot_sslheader.headers.customrequestheaders.X-Forwarded-Proto=https
        - traefik.http.routers.zpwoot_api.middlewares=zpwoot_sslheader@docker

volumes:
  zpwoot_postgres_data:
    driver: local
  zpwoot_nats_data:
    driver: local
  zpwoot_minio_data:
    driver: local
  zpwoot_data:
    driver: local

networks:
  infraNet:
    external: true
    name: infraNet
