version: "3.7"

# Stack OnWapp usando PostgreSQL compartilhado com Chatwoot
# Requer que o banco 'onwapp' seja criado no postgres do Chatwoot

services:

  onwapp_nats:
    image: nats:latest
    command:
      - "--http_port=8222"
      - "--js"
      - "--store_dir=/data"
    volumes:
      - onwapp_nats_data:/data
    networks:
      - infraNet
    environment:
      - TZ=America/Sao_Paulo
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  onwapp_minio:
    image: quay.io/minio/minio:RELEASE.2024-01-13T07-53-03Z-cpuv1
    command: server /data --console-address ":9001"
    hostname: minio
    volumes:
      - onwapp_minio_data:/data
    networks:
      infraNet:
        aliases:
          - minio
    environment:
      - TZ=America/Sao_Paulo
      - MINIO_ROOT_USER=onwapp
      - MINIO_ROOT_PASSWORD=postgres
      - MINIO_BROWSER_REDIRECT_URL=https://minio.yourdomain.com
      - MINIO_SERVER_URL=https://s3.yourdomain.com
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  onwapp_api:
    image: onwapp/onwapp:latest
    volumes:
      - onwapp_data:/app/data
    networks:
      - infraNet
    environment:
      # Database (usando postgres do Chatwoot - criar banco 'onwapp')
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/onwapp?sslmode=disable
      # Server
      - PORT=3000
      - API_KEY=your-api-key-here
      - SERVER_URL=https://wpapi.yourdomain.com
      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      # MinIO
      - MINIO_ENDPOINT=s3.yourdomain.com
      - MINIO_ACCESS_KEY=onwapp
      - MINIO_SECRET_KEY=postgres
      - MINIO_BUCKET=onwapp-media
      - MINIO_USE_SSL=true
      - MINIO_PUBLIC_URL=https://s3.yourdomain.com
      # NATS
      - NATS_ENABLED=true
      - NATS_URL=nats://onwapp_nats:4222
      - NATS_STREAM_PREFIX=ONWAPP
      - TZ=America/Sao_Paulo
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M
      labels:
        - traefik.enable=true
        - traefik.docker.network=infraNet
        - traefik.http.routers.onwapp_api.rule=Host(`wpapi.yourdomain.com`)
        - traefik.http.routers.onwapp_api.entrypoints=websecure
        - traefik.http.routers.onwapp_api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.onwapp_api.priority=1
        - traefik.http.routers.onwapp_api.service=onwapp_api
        - traefik.http.services.onwapp_api.loadbalancer.server.port=3000
        - traefik.http.services.onwapp_api.loadbalancer.passhostheader=true
        - traefik.http.middlewares.onwapp_sslheader.headers.customrequestheaders.X-Forwarded-Proto=https
        - traefik.http.routers.onwapp_api.middlewares=onwapp_sslheader@docker

volumes:
  onwapp_nats_data:
    driver: local
  onwapp_minio_data:
    driver: local
  onwapp_data:
    driver: local

networks:
  infraNet:
    external: true
    name: infraNet
