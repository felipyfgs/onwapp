═══════════════════════════════════════════════════════════════════════════════
                    WHAILEYS LIBRARY - INVESTIGAÇÃO COMPLETA
                              (31 EVENTOS DISPONÍVEIS)
═══════════════════════════════════════════════════════════════════════════════

ESTATÍSTICAS GERAIS:
• Total de eventos disponíveis: 31
• Eventos completamente implementados: 8 (26%)
• Eventos parcialmente implementados: 6 (19%)
• Eventos não implementados: 17 (55%)
• Taxa geral de cobertura: 35%

EVENTO CRÍTICO FALTANDO:
⭐ messaging-history.set (sincronização completa de histórico)

═══════════════════════════════════════════════════════════════════════════════

1. LISTA COMPLETA DE EVENTOS (31)

SINCRONIZAÇÃO DE HISTÓRICO (1):
  ⭐ messaging-history.set [NÃO IMPLEMENTADO]
     Sincroniza: chats[], contacts[], messages[]
     Trigger: HISTORY_SYNC_NOTIFICATION recebido
     Campos: isLatest, progress?, syncType?

MENSAGENS (7):
  ✓ messages.upsert [IMPLEMENTADO]
  ✓ messages.update [IMPLEMENTADO]
  ✓ messages.delete [IMPLEMENTADO]
  ✓ message-receipt.update [IMPLEMENTADO]
  ✗ messages.media-update [NÃO IMPLEMENTADO]
  ✗ messages.reaction [NÃO IMPLEMENTADO]
  ✗ messages.pdo-response [NÃO IMPLEMENTADO]

CHATS (4):
  ✓ chats.upsert [IMPLEMENTADO]
  ✓ chats.update [IMPLEMENTADO - parcial, faltam campos]
  ⚠️ chats.delete [APENAS LOGGING]
  ✗ chats.phoneNumberShare [NÃO IMPLEMENTADO]

CONTATOS (3):
  ✓ contacts.upsert [IMPLEMENTADO]
  ✓ contacts.update [IMPLEMENTADO - parcial, faltam campos]
  ✗ contacts.phone-number-share [NÃO IMPLEMENTADO]

GRUPOS (3):
  ⚠️ groups.upsert [APENAS LOGGING]
  ⚠️ groups.update [APENAS LOGGING]
  ✗ group-participants.update [NÃO IMPLEMENTADO]

CONEXÃO/AUTENTICAÇÃO (2):
  ⚠️ connection.update [PARCIAL - faltam campos]
  ⚠️ creds.update [PARCIAL - apenas salva]

PRESENÇA (1):
  ⚠️ presence.update [APENAS LOGGING]

BLOQUEIO (2):
  ✗ blocklist.set [NÃO IMPLEMENTADO]
  ✗ blocklist.update [NÃO IMPLEMENTADO]

CHAMADAS (1):
  ⚠️ call [APENAS LOGGING]

═══════════════════════════════════════════════════════════════════════════════

2. ESTRUTURA DE DADOS

CONTACT:
  interface Contact {
    id: string;                           ✓ Persistido
    lid?: string;                         ✗ NÃO persistido
    name?: string;                        ✓ Persistido
    notify?: string;                      ✓ Persistido
    verifiedName?: string;                ✗ NÃO persistido
    imgUrl?: string | null | "changed";   ✓ Persistido (com limitações)
    status?: string;                      ✗ NÃO persistido
  }

CHAT:
  type Chat = {
    id?: string;                          ✓ Persistido
    name?: string;                        ✓ Persistido
    unreadCount?: number;                 ✓ Persistido
    archived?: boolean;                   ✗ NÃO persistido
    pinned?: boolean;                     ✗ NÃO persistido
    mute?: { endTimestamp: number };      ✗ NÃO persistido
    conversationTimestamp?: number;       ✓ Persistido
    ephemeralExpiration?: number;         ✗ NÃO persistido
    lastMessageRecvTimestamp?: number;    ~ Parcialmente
    readOnly?: boolean;                   ✗ NÃO persistido
  }

MESSAGE (WAMessage):
  type WAMessage = {
    key: {
      remoteJid: string;                  ✓ Persistido
      fromMe: boolean;                    ✓ Persistido
      id: string;                         ✓ Persistido
      participant?: string;               ✓ Persistido
      [outros campos]                     ✗ NÃO persistidos
    };
    message?: proto.IMessage;             ✓ Persistido
    messageTimestamp?: number;            ✓ Persistido
    status?: number;                      ✗ NÃO persistido
    pushName?: string;                    ✓ Persistido
    broadcast?: boolean;                  ✗ NÃO persistido
    messageStubType?: number;             ✗ NÃO persistido
    retryCount?: number;                  ✗ NÃO persistido
  }

═══════════════════════════════════════════════════════════════════════════════

3. EVENTO CRÍTICO: messaging-history.set

PAYLOAD:
{
  chats: Chat[];                    // Todos os chats sincronizados
  contacts: Contact[];              // Todos os contatos
  messages: WAMessage[];            // Histórico completo (reverse-chronological)
  isLatest: boolean;                // Se é a sincronização mais recente
  progress?: number;                // 0-100 (null se completo)
  syncType?: HistorySyncType;       // Tipo de sincronização
}

TIPOS DE SINCRONIZAÇÃO (syncType):
  0 - INITIAL_BOOTSTRAP: Primeira conexão, histórico completo
  1 - RECENT: Atualizações recentes
  2 - FULL: Histórico completo solicitado
  3 - ON_DEMAND: Sob demanda (scroll no histórico)
  4 - PUSH_NAME: Apenas atualização de nomes

QUANDO EMITIDO:
  Quando WhatsApp Web envia HISTORY_SYNC_NOTIFICATION durante a conexão

FLUXO:
  1. Cliente conecta ao WhatsApp Web
  2. Servidor envia HISTORY_SYNC_NOTIFICATION
  3. whaileys decodifica (lib/Utils/process-message.js:103-131)
  4. Emite messaging-history.set com todos os dados
  5. [AQUI FALTA HANDLER NO ZPWOOT!]
  6. Dados deveriam ser persistidos em batch no banco

═══════════════════════════════════════════════════════════════════════════════

4. CAMPOS NÃO PERSISTIDOS ATUALMENTE

CHAT:
  - archived: boolean (importante para UI)
  - pinned: boolean (importante para UI)
  - mute: { endTimestamp } (quando desfazer mute)
  - ephemeralExpiration: number (duração de mensagens temp)
  - readOnly: boolean (chat bloqueado/somente leitura)

CONTACT:
  - lid: string (Logical ID - importante para sync)
  - verifiedName: string (nome verificado de business)
  - status: string (status/bio do contato)
  - imgUrl: "changed" (flag de atualização de foto)

MESSAGE:
  - status: number (0-4: pending, sent, delivered, read, failed)
  - broadcast: boolean (mensagem broadcast)
  - messageStubType: number (tipo de stub - group updates, etc)
  - retryCount: number (quantas vezes foi retentado)
  - senderLid, participantLid, etc (IDs lógicos)

═══════════════════════════════════════════════════════════════════════════════

5. ARQUIVOS-CHAVE

WHAILEYS:
  /root/zpwoot/node_modules/whaileys/lib/Types/Events.d.ts
    └─ Define todos os 31 eventos (linhas 10-99)

  /root/zpwoot/node_modules/whaileys/lib/Utils/process-message.js
    └─ Processa HISTORY_SYNC_NOTIFICATION (linhas 103-131)
    └─ Chama downloadAndProcessHistorySyncNotification()
    └─ Emite messaging-history.set

  /root/zpwoot/node_modules/whaileys/lib/Socket/chats.js
    └─ newAppStateChunkHandler (linha 313)
    └─ Emite eventos derivados via processSyncAction

  /root/zpwoot/node_modules/whaileys/lib/Utils/chat-utils.js
    └─ processSyncAction() (linha 529-670)
    └─ Converte ações de sync em eventos

ZPWOOT:
  /root/zpwoot/src/whatsapp/whatsapp.service.ts
    └─ registerMainEventListeners (linha 288)
    └─ Listeners atuais: messages.*, chats.*, contacts.*
    └─ [FALTA: messaging-history.set]

  /root/zpwoot/src/webhooks/validators/is-valid-event.validator.ts
    └─ VALID_WEBHOOK_EVENTS já tem todos os 31 eventos!
    └─ Inclui 'messaging-history.set'

═══════════════════════════════════════════════════════════════════════════════

6. RECOMENDAÇÕES

PRIORIDADE 0 - CRÍTICO:
  ⭐ Implementar handler para messaging-history.set
     └─ Sincronizar chats[], contacts[], messages[]
     └─ Suportar progress field (chunks)
     └─ Rastrear isLatest e syncType
     └─ Usar transação para consistência

PRIORIDADE 1 - ALTA:
  • Capturar messages.media-update (manter URLs atualizadas)
  • Capturar messages.reaction (reações)
  • Capturar group-participants.update
  • Estender chats.update: archived, pinned, mute, ephemeralExpiration
  • Estender contacts.update: lid, verifiedName, status
  • Implementar blocklist.set/update

PRIORIDADE 2 - MÉDIA:
  • chats.phoneNumberShare / contacts.phone-number-share
  • messages.pdo-response
  • Melhorar call event logging
  • Capturar message.status em tempo real
  • Capturar message.broadcast e messageStubType

═══════════════════════════════════════════════════════════════════════════════

7. ESTATÍSTICAS DE COBERTURA

Por Categoria:
  Mensagens: 4/7 (57%)
  Chats: 2/4 (50%)
  Contatos: 2/3 (67%)
  Grupos: 0/3 (0%)
  Histórico: 0/1 (0%)
  Conexão: 0/2 (0%)
  Bloqueio: 0/2 (0%)
  Outros: 1/6 (17%)
  
  TOTAL: 9/31 (29%)

Status dos Eventos:
  Implementados: 8 (26%)
  Parciais: 6 (19%)
  Não impl.: 17 (55%)

═══════════════════════════════════════════════════════════════════════════════

8. PARA SABER MAIS

Documento completo com detalhes técnicos:
  /root/zpwoot/WHAILEYS_INVESTIGATION.md

Validador de eventos webhook:
  /root/zpwoot/src/webhooks/validators/is-valid-event.validator.ts

Service principal:
  /root/zpwoot/src/whatsapp/whatsapp.service.ts

═══════════════════════════════════════════════════════════════════════════════

CONCLUSÃO:

A biblioteca whaileys oferece 31 eventos bem estruturados para sincronização
com WhatsApp Web. O projeto zpwoot está capturando ~35% da funcionalidade.

O evento CRÍTICO faltando é "messaging-history.set" que sincroniza o histórico
completo de mensagens, chats e contatos quando o cliente se conecta.

Implementar este evento + os P1 aumentaria a cobertura para ~70% e forneceria
uma experiência de usuário muito mais completa.

═══════════════════════════════════════════════════════════════════════════════
