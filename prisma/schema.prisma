generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SessionStatus {
  disconnected
  connecting
  connected
}

enum WAPrivacyValue {
  all
  contacts
  contact_blacklist
  none
}

enum WAPrivacyOnlineValue {
  all
  match_last_seen
}

enum WAPrivacyCallValue {
  all
  known
}

enum WAPrivacyMessagesValue {
  all
  contacts
}

enum WAReadReceiptsValue {
  all
  none
}

enum WAPrivacyGroupAddValue {
  all
  contacts
  contact_blacklist
}

model Session {
  id          String           @id @default(uuid())
  name        String
  status      SessionStatus    @default(disconnected)
  qrCode      String?
  phoneNumber String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  authState   AuthState[]
  webhooks    Webhook[]
  contacts    Contact[]
  chats       Chat[]
  messages    Message[]
  settings    SessionSettings?
  chatwoot    Chatwoot?

  @@map("Session")
}

model AuthState {
  id        String   @id @default(uuid())
  sessionId String
  keyType   String   // Tipos: creds, pre-key, session, app-state-sync-key, app-state-sync-version, sender-key, sender-key-memory
  keyId     String   // Identificador único para cada key dentro do tipo
  keyData   Json     // Dados da chave em formato JSON (com BufferJSON para buffers)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, keyType, keyId])
  @@map("AuthState")
}

model Webhook {
  id        String   @id @default(cuid())
  sessionId String   @unique
  enabled   Boolean  @default(true)
  url       String
  events    String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("Webhook")
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

model Contact {
  id             String   @id @default(uuid())
  sessionId      String
  remoteJid      String
  name           String?
  profilePicUrl  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  session        Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, remoteJid])
  @@index([sessionId, name])
  @@map("Contact")
}

model Chat {
  id                    String    @id @default(uuid())
  sessionId             String
  remoteJid             String
  name                  String?
  unreadCount           Int       @default(0)
  lastMessageTimestamp  BigInt?
  archived              Boolean   @default(false)
  pinned                Boolean   @default(false)
  muted                 Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  session               Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  messages              Message[]

  @@unique([sessionId, remoteJid])
  @@index([sessionId, lastMessageTimestamp])
  @@map("Chat")
}

model Message {
  id            String        @id @default(uuid())
  sessionId     String
  chatId        String
  remoteJid     String
  messageId     String
  fromMe        Boolean
  senderJid     String?
  senderName    String?
  timestamp     BigInt
  messageType   String
  
  // Campos separados do JSON para performance
  textContent   String?        // Movido do JSON - busca textual rápida
  mediaUrl      String?        // Movido do JSON - acesso direto à mídia
  fileLength    BigInt?        // Movido do JSON - filtrar por tamanho
  
  // JSON mantido mas limpo (sem dados pesados)
  content       Json           // Apenas metadados leves
  
  // Chatwoot tracking fields
  chatwootConversationId  Int?     // ID da conversa no Chatwoot
  chatwootMessageId       Int?     // ID da mensagem no Chatwoot
  chatwootInboxId         Int?     // ID do inbox no Chatwoot
  chatwootContactId       Int?     // ID do contato no Chatwoot
  
  // WhatsApp message key for reply/edit/delete operations
  waMessageKey  Json?    // { id, remoteJid, fromMe, participant? }
  
  status        MessageStatus @default(pending)
  isDeleted     Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  session       Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  chat          Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)
  statusHistory  MessageStatusHistory[]

  @@unique([sessionId, messageId])
  @@index([sessionId, chatId, timestamp])
  @@index([status])                    // Para os muitos updates de status
  @@index([textContent])                // Para busca textual
  @@index([mediaUrl])                  // Para filtrar mídias
  @@index([messageType])                // Para filtrar tipos
  @@index([timestamp])                  // Para queries por tempo
  @@index([chatwootConversationId])     // Para buscar msgs por conversa Chatwoot
  @@index([chatwootMessageId])          // Para buscar msg específica do Chatwoot
  @@map("Message")
}

model MessageStatusHistory {
  id          String   @id @default(uuid())
  messageId   String
  status      MessageStatus
  timestamp   BigInt
  recipientJid String?  // Para receipts em grupos
  createdAt   DateTime @default(now())
  
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@index([timestamp])
  @@map("MessageStatusHistory")
}

model SessionSettings {
  id              String                  @id @default(uuid())
  sessionId       String                  @unique
  rejectCall      Boolean                 @default(false)
  groupsIgnore    Boolean                 @default(false)
  alwaysOnline    Boolean                 @default(false)
  readMessages    Boolean                 @default(false)
  readStatus      Boolean                 @default(false)
  syncFullHistory Boolean                 @default(true)
  profilePicture  WAPrivacyValue?
  status          WAPrivacyValue?
  lastSeen        WAPrivacyValue?
  online          WAPrivacyOnlineValue?
  call            WAPrivacyCallValue?
  messages        WAPrivacyMessagesValue?
  readReceipts    WAReadReceiptsValue?
  groupsAdd       WAPrivacyGroupAddValue?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  session         Session                 @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("SessionSettings")
}

model Chatwoot {
  id                      String   @id @default(cuid())
  sessionId               String   @unique
  enabled                 Boolean  @default(false)
  accountId               String?
  token                   String?
  url                     String?
  nameInbox               String?
  signMsg                 Boolean  @default(false)
  signDelimiter           String?  @default("\\n")
  reopenConversation      Boolean  @default(false)
  conversationPending     Boolean  @default(false)
  mergeBrazilContacts     Boolean  @default(false)
  importContacts          Boolean  @default(false)
  importMessages          Boolean  @default(false)
  daysLimitImportMessages Int?     @default(3)
  organization            String?
  logo                    String?
  ignoreJids              String[] @default([])
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  session                 Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("Chatwoot")
}
