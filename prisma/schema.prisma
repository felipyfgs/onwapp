generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SessionStatus {
  disconnected
  connecting
  connected
}

enum WAPrivacyValue {
  all
  contacts
  contact_blacklist
  none
}

enum WAPrivacyOnlineValue {
  all
  match_last_seen
}

enum WAPrivacyCallValue {
  all
  known
}

enum WAPrivacyMessagesValue {
  all
  contacts
}

enum WAReadReceiptsValue {
  all
  none
}

enum WAPrivacyGroupAddValue {
  all
  contacts
  contact_blacklist
}

model Session {
  id        String           @id @default(uuid())
  name      String
  status    SessionStatus    @default(disconnected)
  qrCode    String?
  phone     String?          @map("phoneNumber")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  authState   AuthState[]
  webhook     Webhook?
  contacts    Contact[]
  chats       Chat[]
  messages    Message[]
  settings    SessionSettings?
  chatwoot    Chatwoot?
  proxy       Proxy?
  groups      Group[]
  calls       Call[]

  @@map("Session")
}

model Proxy {
  id        String   @id @default(cuid())
  sessionId String   @unique
  enabled   Boolean  @default(false)
  host      String?
  port      Int?
  protocol  String?  @default("http") // http, https, socks4, socks5
  username  String?
  password  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("Proxy")
}

model AuthState {
  id        String   @id @default(uuid())
  sessionId String
  keyType   String   // Tipos: creds, pre-key, session, app-state-sync-key, app-state-sync-version, sender-key, sender-key-memory
  keyId     String   // Identificador Ãºnico para cada key dentro do tipo
  keyData   Json     // Dados da chave em formato JSON (com BufferJSON para buffers)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, keyType, keyId])
  @@map("AuthState")
}

model Webhook {
  id        String   @id @default(cuid())
  sessionId String   @unique
  enabled   Boolean  @default(true)
  url       String
  events    String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("Webhook")
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

model Contact {
  id        String   @id @default(uuid())
  sessionId String
  remoteJid String
  name      String?
  avatarUrl String?  @map("profilePicUrl")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, remoteJid])
  @@index([sessionId, name])
  @@map("Contact")
}

model Chat {
  id            String    @id @default(uuid())
  sessionId     String
  remoteJid     String
  name          String?
  unread        Int       @default(0) @map("unreadCount")
  lastMessageTs BigInt?   @map("lastMessageTimestamp")
  archived      Boolean   @default(false)
  pinned        Boolean   @default(false)
  muted         Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  session       Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([sessionId, remoteJid])
  @@index([sessionId, lastMessageTs])
  @@map("Chat")
}

model Message {
  id          String        @id @default(uuid())
  sessionId   String
  chatId      String
  remoteJid   String
  messageId   String
  fromMe      Boolean
  senderJid   String?
  sender      String?       @map("senderName")
  timestamp   BigInt
  messageType String
  
  textContent String?
  mediaUrl    String?
  fileLength  BigInt?
  content     Json
  
  // Chatwoot tracking
  cwConversationId Int?     @map("chatwootConversationId")
  cwMessageId      Int?     @map("chatwootMessageId")
  cwInboxId        Int?     @map("chatwootInboxId")
  cwContactId      Int?     @map("chatwootContactId")
  
  // WhatsApp message key
  waMessageKey Json?
  waMessage    Json?
  
  status    MessageStatus @default(pending)
  deleted   Boolean       @default(false) @map("isDeleted")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  session       Session              @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  chat          Chat                 @relation(fields: [chatId], references: [id], onDelete: Cascade)
  statusHistory MessageStatusHistory[]
  reactions     MessageReaction[]

  @@unique([sessionId, messageId])
  @@index([sessionId, chatId, timestamp])
  @@index([status])
  @@index([textContent])
  @@index([mediaUrl])
  @@index([messageType])
  @@index([timestamp])
  @@index([cwConversationId])
  @@index([cwMessageId])
  @@map("Message")
}

model MessageStatusHistory {
  id          String   @id @default(uuid())
  messageId   String
  status      MessageStatus
  timestamp   BigInt
  recipientJid String?  // Para receipts em grupos
  createdAt   DateTime @default(now())
  
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@index([timestamp])
  @@map("MessageStatusHistory")
}

model SessionSettings {
  id              String                  @id @default(uuid())
  sessionId       String                  @unique
  rejectCall      Boolean                 @default(false)
  ignoreGroups    Boolean                 @default(false) @map("groupsIgnore")
  alwaysOnline    Boolean                 @default(false)
  readMessages    Boolean                 @default(false)
  readStatus      Boolean                 @default(false)
  syncFullHistory Boolean                 @default(true)
  profilePicture  WAPrivacyValue?
  status          WAPrivacyValue?
  lastSeen        WAPrivacyValue?
  online          WAPrivacyOnlineValue?
  call            WAPrivacyCallValue?
  messages        WAPrivacyMessagesValue?
  readReceipts    WAReadReceiptsValue?
  groupsAdd       WAPrivacyGroupAddValue?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  session         Session                 @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("SessionSettings")
}

model Chatwoot {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  enabled         Boolean  @default(false)
  accountId       String?
  token           String?
  url             String?
  inbox           String?  @map("nameInbox")
  signMsg         Boolean  @default(false)
  signDelimiter   String?  @default("\\n")
  reopen          Boolean  @default(false) @map("reopenConversation")
  pending         Boolean  @default(false) @map("conversationPending")
  mergeBrazil     Boolean  @default(false) @map("mergeBrazilContacts")
  importContacts  Boolean  @default(false)
  importMessages  Boolean  @default(false)
  importDays      Int?     @default(3) @map("daysLimitImportMessages")
  organization    String?
  logo            String?
  ignoreJids      String[] @default([])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("Chatwoot")
}

model Group {
  id            String   @id @default(uuid())
  sessionId     String
  groupJid      String
  subject       String?
  owner         String?
  description   String?
  participants  Json?
  creation      BigInt?
  restrict      Boolean  @default(false)
  announce      Boolean  @default(false)
  size          Int?
  ephemeral     Int?
  inviteCode    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  session       Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, groupJid])
  @@index([sessionId])
  @@map("Group")
}

model MessageReaction {
  id          String   @id @default(uuid())
  messageId   String
  senderJid   String
  reaction    String
  timestamp   BigInt
  createdAt   DateTime @default(now())
  
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, senderJid])
  @@index([messageId])
  @@map("MessageReaction")
}

enum CallStatus {
  ringing
  accepted
  rejected
  missed
  timeout
}

model Call {
  id          String     @id @default(uuid())
  sessionId   String
  callId      String
  fromJid     String
  toJid       String?
  status      CallStatus @default(ringing)
  isVideo     Boolean    @default(false)
  isGroup     Boolean    @default(false)
  timestamp   BigInt
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  session     Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, callId])
  @@index([sessionId])
  @@index([timestamp])
  @@map("Call")
}
